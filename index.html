<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íˆ¬ì–´ë©”ì´ì»¤ - ì„¸ê³„ ì—¬í–‰ ë§ˆìŠ¤í„° (US Legend Mode)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=Roboto+Slab:wght@700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        #map { height: 350px; width: 100%; border-radius: 0.5rem; z-index: 1; }
        
        .quiz-img { 
            height: 280px; 
            width: 100%; 
            object-fit: contain; /* êµ­ê¸° ë¹„ìœ¨ ìœ ì§€ë¥¼ ìœ„í•´ containìœ¼ë¡œ ë³€ê²½ */
            border-radius: 0.5rem;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
        }
        
        .correct-anim { animation: bounce 0.5s; }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .modal-overlay { background-color: rgba(0, 0, 0, 0.85); }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: #000; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        .option-btn { min-height: 60px; }

        .brand-card {
            font-family: 'Roboto Slab', serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            color: #343a40;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.8rem 1.2rem;
            margin: 0.3rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            font-size: 1.0rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: transform 0.2s;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col items-center">

    <!-- í—¤ë” -->
    <header class="w-full bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgHfgIX70O5k6Anuo0UgALIdaG9jSga9auHu3uyz0uEirylGPAJnjN_qQbvEGMUvPqUQf_g9FMNUHRxlDcUBf4vZ3Mpy4TnA9WxbmzWYK11gt2zuy_Irl4wctNFjcjLyPo0GPXV792o_J7L9guRMuDfeC1gy7USwywjYbECZgzcsHybuGRRAXAnO1eNmP8/s320/logo.png" 
                 alt="Tourmaker Logo" class="h-10 w-auto object-contain">
            <div class="flex flex-col">
                <h1 class="text-lg sm:text-xl font-bold text-slate-800 leading-tight">World Travel <span class="text-red-600">US Special</span></h1>
                <span class="text-xs text-slate-500">With Sungbin</span>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-slate-600 font-medium">
                LV.<span id="level-display" class="font-bold text-slate-800">1</span>
            </div>
            <div class="text-slate-600 font-medium">
                Score: <span id="score" class="text-blue-600 font-bold text-lg">0</span>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ê²Œì„ ì˜ì—­ -->
    <main class="w-full max-w-2xl p-4 flex-grow flex flex-col gap-4">
        
        <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 text-center relative overflow-hidden">
            <div id="us-special-badge" class="hidden absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-bl-lg animate-pulse">
                ğŸ‡ºğŸ‡¸ ë¯¸êµ­ íŠ¹ë³„í¸
            </div>
            <span id="quiz-type-badge" class="inline-block px-3 py-1 rounded-full text-xs font-bold text-white bg-blue-500 mb-2">Quiz</span>
            <h2 id="question-title" class="text-xl font-black text-slate-800 mb-1">ì—¬í–‰ ì¤€ë¹„ ì¤‘...</h2>
            <p id="question-desc" class="text-sm text-slate-500">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
        </div>

        <div class="bg-white p-2 rounded-lg shadow-lg border border-slate-300 relative min-h-[300px] flex items-center justify-center overflow-hidden">
            
            <div id="map-container" class="w-full h-full hidden">
                <div id="map"></div>
                <div class="absolute bottom-4 right-4 bg-white/90 px-3 py-1 rounded shadow text-xs font-bold text-slate-600 z-[1000]">
                    <span class="inline-block w-3 h-3 rounded-full bg-green-500 opacity-50 mr-1 align-middle"></span>ì˜ì—­ íŒíŠ¸
                </div>
            </div>

            <div id="flag-container" class="w-full h-full hidden flex-col items-center justify-center p-4 bg-slate-50">
                <img id="flag-image" src="" alt="Flag" class="quiz-img">
            </div>

            <div id="landmark-container" class="w-full h-full hidden flex-col items-center justify-center p-2 bg-slate-100">
                <img id="landmark-image" src="" alt="Landmark" class="quiz-img w-full object-cover rounded-lg shadow-md" style="object-fit: cover;">
                <div class="mt-2 text-xs text-slate-400 font-medium">AI Generated Landmark (Preview)</div>
            </div>

            <div id="text-quiz-container" class="w-full min-h-[250px] hidden flex flex-col items-center justify-center p-6 bg-gradient-to-br from-indigo-50 to-blue-50 text-center">
                <div class="text-6xl mb-4" id="quiz-icon">ğŸ‘œ</div>
                <div id="text-quiz-content" class="w-full"></div>
            </div>

            <div id="loading" class="absolute inset-0 bg-white/95 z-20 flex flex-col items-center justify-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600 mb-4"></div>
                <span class="text-blue-600 font-bold text-lg">ë‹¤ìŒ ì—¬í–‰ì§€ë¡œ ì´ë™ ì¤‘...</span>
                <p class="text-xs text-slate-400 mt-2">ë¯¸êµ­ 50ê°œ ì£¼ í¬í•¨ ë¡œë”© ì¤‘ (3ì´ˆ ì œí•œ)</p>
                <button onclick="forceStopLoading()" class="mt-4 px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded text-slate-600 text-xs font-bold">
                    ë©ˆì·„ë‚˜ìš”? ì—¬ê¸° í´ë¦­
                </button>
            </div>
        </div>

        <div id="options-container" class="grid grid-cols-2 gap-3 mt-2 min-h-[150px]"></div>

    </main>

    <!-- ë¹„ë””ì˜¤ ëª¨ë‹¬ -->
    <div id="video-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center">
        <div class="absolute inset-0 modal-overlay backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="relative w-11/12 max-w-2xl bg-white rounded-xl shadow-2xl overflow-hidden border-4 border-white flex flex-col max-h-[90vh]">
            <div class="bg-blue-600 text-white p-3 flex justify-between items-center shrink-0">
                <h3 class="font-bold flex items-center gap-2">
                    <span>ğŸ‰ ì •ë‹µ! íˆ¬ì–´ë©”ì´ì»¤ ì¶”ì²œ ì—¬í–‰ì§€</span>
                </h3>
                <button onclick="closeModal()" class="hover:bg-blue-700 rounded-full p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="video-container bg-black shrink-0">
                <iframe id="reward-video" src="" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
            
            <div class="p-4 text-center bg-slate-50 flex flex-col gap-3 overflow-y-auto">
                <p class="text-slate-800 font-bold text-lg" id="modal-title">êµ­ê°€ ì´ë¦„</p>
                <p class="text-slate-600 text-sm whitespace-pre-wrap" id="modal-desc">ì„¤ëª…</p>
                
                <a id="video-fallback-link" href="#" target="_blank" class="block w-full py-2 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg text-sm font-bold transition-colors">
                    ğŸ“º ì˜ìƒì´ ì•ˆ ë‚˜ì˜¤ë‚˜ìš”? ìœ íŠœë¸Œ ì•±ì—ì„œ ë³´ê¸° (í´ë¦­)
                </a>

                <button onclick="closeModal()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition-all transform hover:scale-105 mt-2">
                    ë‹¤ìŒ ë¬¸ì œ í’€ê¸° (Next Level) â¡
                </button>
            </div>
        </div>
    </div>

    <!-- í‘¸í„° -->
    <footer class="w-full bg-slate-800 text-slate-300 p-6 text-center mt-auto">
        <p class="font-bold text-lg mb-1">Tourmaker Smart Guide</p>
        <p class="text-sm opacity-75">Designed by <span class="text-yellow-400 font-bold">Sebastian & Sungbin</span></p>
        <p class="text-xs mt-2 opacity-50">Since 2019 â€¢ Gangwon-do, Korea</p>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // ë‚œì´ë„: LEGEND + US States Edition
        // isUS: true ì†ì„±ì„ ì¶”ê°€í•˜ì—¬ ë¯¸êµ­ ì£¼(State)ì„ì„ í‘œì‹œ
        const countries = [
            // --- ğŸ‡ºğŸ‡¸ USA Special: 50 States (Selected Hard & Popular) ---
            { 
                name: "ìº˜ë¦¬í¬ë‹ˆì•„ (California)", 
                capital: "ìƒˆí¬ë¼ë©˜í†  (Sacramento)", 
                brands: ["Hollywood", "Silicon Valley", "Golden Gate"], 
                lat: 36.77, lng: -119.41, zoom: 6, radius: 250000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/0/01/Flag_of_California.svg",
                videoId: "NIbkqk5Lwts", 
                isUS: true 
            },
            { 
                name: "í…ì‚¬ìŠ¤ (Texas)", 
                capital: "ì˜¤ìŠ¤í‹´ (Austin)", 
                brands: ["NASA Houston", "BBQ", "Lone Star"], 
                lat: 31.96, lng: -99.90, zoom: 6, radius: 300000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/f/f7/Flag_of_Texas.svg",
                videoId: "y097x_n6gW8", 
                isUS: true 
            },
            { 
                name: "ë‰´ìš• ì£¼ (New York State)", 
                capital: "ì˜¬ë²„ë‹ˆ (Albany)", 
                brands: ["Wall Street", "Broadway", "Niagara Falls"], 
                lat: 43.29, lng: -74.21, zoom: 7, radius: 150000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/1/1a/Flag_of_New_York.svg",
                videoId: "MtCMtC50gwY", 
                isUS: true 
            },
            { 
                name: "í”Œë¡œë¦¬ë‹¤ (Florida)", 
                capital: "íƒ¤ëŸ¬í•´ì‹œ (Tallahassee)", 
                brands: ["Disney World", "Miami Beach", "Alligator"], 
                lat: 27.66, lng: -81.51, zoom: 6, radius: 200000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/f/f7/Flag_of_Florida.svg",
                videoId: "ZerT21F7fP0", 
                isUS: true 
            },
            { 
                name: "í•˜ì™€ì´ (Hawaii)", 
                capital: "í˜¸ë†€ë£°ë£¨ (Honolulu)", 
                brands: ["Waikiki", "Aloha", "Volcano"], 
                lat: 20.79, lng: -156.33, zoom: 7, radius: 100000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/e/ef/Flag_of_Hawaii.svg",
                videoId: "A5iI3bT9HnI", 
                isUS: true 
            },
            { 
                name: "ì•Œë˜ìŠ¤ì¹´ (Alaska)", 
                capital: "ì£¼ë…¸ (Juneau)", 
                brands: ["Glacier", "Aurora", "Grizzly Bear"], 
                lat: 64.20, lng: -149.49, zoom: 5, radius: 500000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/e/e6/Flag_of_Alaska.svg",
                videoId: "C2t01Yl9SgU", 
                isUS: true 
            },
            { 
                name: "ë„¤ë°”ë‹¤ (Nevada)", 
                capital: "ì¹´ìŠ¨ì‹œí‹° (Carson City)", 
                brands: ["Las Vegas", "Desert", "Casino"], 
                lat: 38.80, lng: -116.41, zoom: 6, radius: 200000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/f/f1/Flag_of_Nevada.svg",
                videoId: "_8gFpXzZ0E4", 
                isUS: true 
            },
            { 
                name: "ì›Œì‹±í„´ ì£¼ (Washington State)", 
                capital: "ì˜¬ë¦¼í”¼ì•„ (Olympia)", 
                brands: ["Starbucks", "Microsoft", "Seattle"], 
                lat: 47.75, lng: -120.74, zoom: 7, radius: 150000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/5/54/Flag_of_Washington.svg",
                videoId: "0Y2Q0J-1hls", 
                isUS: true 
            },
            { 
                name: "ì½œë¡œë¼ë„ (Colorado)", 
                capital: "ë´ë²„ (Denver)", 
                brands: ["Rocky Mountains", "Skiing", "Aspen"], 
                lat: 39.55, lng: -105.78, zoom: 7, radius: 200000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/4/46/Flag_of_Colorado.svg",
                videoId: "u6d5Q9-3rOc", 
                isUS: true 
            },
            { 
                name: "ì• ë¦¬ì¡°ë‚˜ (Arizona)", 
                capital: "í”¼ë‹‰ìŠ¤ (Phoenix)", 
                brands: ["Grand Canyon", "Cactus", "Sedona"], 
                lat: 34.04, lng: -111.09, zoom: 6, radius: 200000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/9/9d/Flag_of_Arizona.svg",
                videoId: "tKz-3sO8l9o", 
                isUS: true 
            },

            // --- Legend Level: Unrecognized & Territories (Existing) ---
            { 
                name: "ê·¸ë¦°ë€ë“œ (Greenland)", 
                capital: "ëˆ„í¬ (Nuuk)", 
                brands: ["Royal Greenland", "Inuit Art"], 
                lat: 64.1, lng: -51.7, zoom: 4, radius: 800000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/0/09/Flag_of_Greenland.svg",
                videoId: "SQtbZPlMeU0" 
            },
            { 
                name: "í”„ë‘ìŠ¤ë ¹ ê¸°ì•„ë‚˜ (French Guiana)", 
                capital: "ì¹´ì˜Œ (Cayenne)", 
                brands: ["Ariane Space", "Devil's Island"], 
                lat: 3.9, lng: -53.1, zoom: 7, radius: 100000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/2/29/Flag_of_French_Guiana.svg",
                videoId: "kCXy0fyJm5A" 
            },
            { 
                name: "ì•í•˜ì§€ì•„ (Abkhazia)", 
                capital: "ìˆ˜í›„ë¯¸ (Sukhumi)", 
                brands: ["Lake Ritsa", "Wine"], 
                lat: 43.0, lng: 41.0, zoom: 8, radius: 40000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/2/27/Flag_of_Abkhazia.svg",
                videoId: "_16dMF45rhQ" 
            },
            { 
                name: "í‚¤í”„ë¡œìŠ¤ (Cyprus)", 
                capital: "ë‹ˆì½”ì‹œì•„ (Nicosia)", 
                brands: ["Halloumi", "Aphrodite"], 
                lat: 35.1, lng: 33.3, zoom: 8, radius: 50000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/d/d4/Flag_of_Cyprus.svg",
                videoId: "GMNzMWuVzT8" 
            },

            // --- Hard Level ---
            { name: "ê°€ë‚˜ (Ghana)", capital: "ì•„í¬ë¼ (Accra)", brands: ["Cocoa", "Gold", "Kente Cloth"], lat: 7.9, lng: -1.0, zoom: 6, radius: 250000, flagUrl: "https://flagcdn.com/h240/gh.png", videoId: "wIE-CxkN5d0" },
            { name: "íŠ¸ë¦¬ë‹ˆë‹¤ë“œ í† ë°”ê³  (Trinidad & Tobago)", capital: "í¬íŠ¸ì˜¤ë¸ŒìŠ¤í˜ì¸ (Port of Spain)", brands: ["Angostura", "Carnival", "Steelpan"], lat: 10.6, lng: -61.2, zoom: 8, radius: 60000, flagUrl: "https://flagcdn.com/h240/tt.png", videoId: "fOBg4Y9HxS4" },
            { name: "íŒŒë‚˜ë§ˆ (Panama)", capital: "íŒŒë‚˜ë§ˆì‹œí‹° (Panama City)", brands: ["Panama Canal", "Copa Airlines"], lat: 8.9, lng: -79.5, zoom: 7, radius: 150000, flagUrl: "https://flagcdn.com/h240/pa.png", videoId: "OnXI4-fCTcg" },
            { name: "ë³¼ë¦¬ë¹„ì•„ (Bolivia)", capital: "ë¼íŒŒìŠ¤ (La Paz)", brands: ["Uyuni Salt Flat", "Llama", "Coca Tea"], lat: -16.5, lng: -68.1, zoom: 5, radius: 800000, flagUrl: "https://flagcdn.com/h240/bo.png", videoId: "nq8NJBJqZT0" },
            { name: "ë¯¸ì–€ë§ˆ (Myanmar)", capital: "ë„¤í”¼ë„ (Naypyidaw)", brands: ["Jade", "Ruby", "Bagan", "Teak"], lat: 19.7, lng: 96.1, zoom: 5, radius: 600000, flagUrl: "https://flagcdn.com/h240/mm.png", videoId: "bpWbwMoYISk" },
            
            // --- Standard Level ---
            { name: "ë…ì¼ (Germany)", capital: "ë² ë¥¼ë¦° (Berlin)", brands: ["BMW", "Adidas"], lat: 51.1, lng: 10.4, zoom: 6, radius: 350000, flagUrl: "https://flagcdn.com/h240/de.png", videoId: "8DEozJok3U8" },
            { name: "ëª¨ë¡œì½” (Morocco)", capital: "ë¼ë°”íŠ¸ (Rabat)", brands: ["Argan Oil", "Couscous"], lat: 31.7, lng: -7.0, zoom: 5, radius: 500000, flagUrl: "https://flagcdn.com/h240/ma.png", videoId: "nzD3e3Qr7g8" }, 
            { name: "ëª½ê³¨ (Mongolia)", capital: "ìš¸ë€ë°”í† ë¥´ (Ulaanbaatar)", brands: ["Gobi Cashmere", "Ger"], lat: 46.8, lng: 103.8, zoom: 5, radius: 800000, flagUrl: "https://flagcdn.com/h240/mn.png", videoId: "GdydPGQ7muI" },
            { name: "ì¹ ë ˆ (Chile)", capital: "ì‚°í‹°ì•„ê³  (Santiago)", brands: ["LATAM Airlines", "Wine"], lat: -35.6, lng: -71.5, zoom: 4, radius: 1500000, flagUrl: "https://flagcdn.com/h240/cl.png", videoId: "uq-zfnpxLSw" }, 
            { name: "í¬ë¥´íˆ¬ê°ˆ (Portugal)", capital: "ë¦¬ìŠ¤ë³¸ (Lisbon)", brands: ["TAP Air", "Cork"], lat: 39.3, lng: -8.2, zoom: 7, radius: 200000, flagUrl: "https://flagcdn.com/h240/pt.png", videoId: "fk2Onka7oBI" },
            { name: "ì´ì§‘íŠ¸ (Egypt)", capital: "ì¹´ì´ë¡œ (Cairo)", brands: ["EgyptAir", "Cotton"], lat: 26.8, lng: 30.8, zoom: 6, radius: 500000, flagUrl: "https://flagcdn.com/h240/eg.png", videoId: "9kYbtuKYU-4" },
            { name: "ëŒ€í•œë¯¼êµ­ (South Korea)", capital: "ì„œìš¸ (Seoul)", brands: ["Samsung", "Hyundai", "BTS"], lat: 36.5, lng: 127.8, zoom: 6, radius: 250000, flagUrl: "https://flagcdn.com/h240/kr.png", videoId: "3P1CnWI62Ik" },
            { name: "í”„ë‘ìŠ¤ (France)", capital: "íŒŒë¦¬ (Paris)", brands: ["Louis Vuitton", "Chanel", "Renault"], lat: 46.2, lng: 2.2, zoom: 6, radius: 450000, flagUrl: "https://flagcdn.com/h240/fr.png", videoId: "-q6iol-BEEw" }
        ];

        let map;
        let mapCircle;
        let currentRound = 0;
        let score = 0;
        let currentCountry = null;
        let currentType = ''; 
        let isAnswered = false;
        let safeTimer = null;
        
        let prevCountryIndex = null;
        let prevType = null;

        // [Helper] ì´ë¦„ ë¶„ë¦¬ í•¨ìˆ˜
        function splitNamePair(fullText) {
            if (!fullText) return { ko: "Unknown", en: "" };
            if (!fullText.includes('(')) return { ko: fullText.trim(), en: "" };
            const [koPart, rest] = fullText.split('(');
            const enPart = rest.replace(')', '').trim();
            return { ko: koPart.trim(), en: enPart };
        }

        // [New] Wikipedia Image Fetcher
        async function fetchWikiImage(query) {
            try {
                if (!query) return null;
                // ìœ„í‚¤ë°±ê³¼ API í˜¸ì¶œ (ì¸ë„¤ì¼ ì‚¬ì´ì¦ˆ 600px ìš”ì²­)
                // "New York State" -> "New York" for better landmark match if needed, but Capital is safer.
                // Using Capital for landmarks is generally safer.
                const url = `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(query)}&prop=pageimages&format=json&pithumbsize=600&origin=*&redirects`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (!data || !data.query || !data.query.pages) return null;
                
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                
                if (pageId === "-1") return null; 
                
                if (pages[pageId].thumbnail && pages[pageId].thumbnail.source) {
                    return pages[pageId].thumbnail.source;
                }
                return null;
            } catch (e) {
                console.error("Wiki fetch error:", e);
                return null;
            }
        }

        function initMap() {
            try {
                map = L.map('map', {
                    zoomControl: true, attributionControl: false,
                    dragging: true, scrollWheelZoom: true, doubleClickZoom: true
                }).setView([39.8, -98.5], 3); // Center on USA roughly

                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri', maxZoom: 17
                }).addTo(map);

                startGame();
            } catch (error) {
                console.error("Map initialization failed:", error);
                document.getElementById('question-title').textContent = "ì˜¤ë¥˜ ë°œìƒ";
                document.getElementById('question-desc').textContent = "ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.";
            }
        }

        function startGame() {
            nextRound();
        }

        function forceStopLoading() {
            const loader = document.getElementById('loading');
            if (loader && !loader.classList.contains('hidden')) {
                loader.classList.add('hidden');
            }
        }

        function handleImageError() {
            console.warn("Image failed, falling back to flag quiz");
            forceStopLoading(); 
            currentType = 'flag';
            updateDisplayForRound(); 
        }

        function nextRound() {
            if (safeTimer) clearTimeout(safeTimer);
            document.getElementById('loading').classList.remove('hidden');
            safeTimer = setTimeout(forceStopLoading, 4000); 

            const modal = document.getElementById('video-modal');
            const iframe = document.getElementById('reward-video');
            if(iframe) iframe.src = ""; 
            if(modal) modal.classList.add('hidden');

            isAnswered = false;
            currentRound++;
            document.getElementById('level-display').textContent = currentRound;
            
            const container = document.getElementById('options-container');
            if(container) {
                container.innerHTML = '';
                container.classList.remove('opacity-50', 'pointer-events-none');
            }
            
            if (map && mapCircle) {
                map.removeLayer(mapCircle);
                mapCircle = null;
            }
            
            const types = ['map', 'flag', 'landmark', 'brand'];
            let newType;
            do {
                newType = types[Math.floor(Math.random() * types.length)];
            } while (types.length > 1 && newType === prevType);
            currentType = newType;
            prevType = newType;
            
            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * countries.length);
            } while (countries.length > 1 && randomIndex === prevCountryIndex);
            
            prevCountryIndex = randomIndex;
            currentCountry = countries[randomIndex];

            try {
                updateDisplayForRound();
            } catch (error) {
                currentType = 'flag';
                updateDisplayForRound();
            }

            createOptions();

            // [ìµœí›„ ë°©ì–´]
            setTimeout(() => {
                forceStopLoading();
            }, 4000);
        }

        function updateDisplayForRound() {
            const titleEl = document.getElementById('question-title');
            const descEl = document.getElementById('question-desc');
            const badgeEl = document.getElementById('quiz-type-badge');
            const usBadge = document.getElementById('us-special-badge');
            
            const mapContainer = document.getElementById('map-container');
            const flagContainer = document.getElementById('flag-container');
            const landmarkContainer = document.getElementById('landmark-container'); 
            const textContainer = document.getElementById('text-quiz-container');
            
            const textContent = document.getElementById('text-quiz-content');
            const flagImg = document.getElementById('flag-image');
            const landmarkImg = document.getElementById('landmark-image'); 
            const quizIcon = document.getElementById('quiz-icon');

            // í•¸ë“¤ëŸ¬ ì´ˆê¸°í™”
            landmarkImg.onload = null;
            landmarkImg.onerror = null;
            flagImg.onload = null;
            flagImg.onerror = null;

            mapContainer.classList.add('hidden');
            flagContainer.classList.add('hidden');
            landmarkContainer.classList.add('hidden'); 
            textContainer.classList.add('hidden');

            // US Badge Logic
            if (currentCountry.isUS) {
                usBadge.classList.remove('hidden');
            } else {
                usBadge.classList.add('hidden');
            }

            const namePair = splitNamePair(currentCountry.name);
            const capitalPair = splitNamePair(currentCountry.capital);
            const countryKo = namePair.ko;
            const countryEn = namePair.en || 'Country';
            const capitalKo = capitalPair.ko;
            const capitalEn = capitalPair.en || capitalPair.ko;
            const safeBrands = currentCountry.brands || [];

            if (currentType === 'map') {
                badgeEl.textContent = currentCountry.isUS ? "ë¯¸êµ­ ì§€ë¦¬ í€´ì¦ˆ" : "ì„¸ê³„ ì§€ë¦¬ í€´ì¦ˆ";
                badgeEl.className = "inline-block px-3 py-1 rounded-full text-xs font-bold text-white bg-green-600 mb-2";
                titleEl.textContent = "ğŸŒ ì´ê³³ì€ ì–´ë””ì¼ê¹Œìš”?";
                descEl.textContent = "ì´ˆë¡ìƒ‰ ì˜ì—­ì„ ë³´ê³  ì •ë‹µì„ ë§ì¶°ë³´ì„¸ìš”!";
                mapContainer.classList.remove('hidden');
                
                setTimeout(() => {
                    if (!map) {
                        currentType = 'flag';
                        updateDisplayForRound();
                        return;
                    }

                    const lat = parseFloat(currentCountry.lat);
                    const lng = parseFloat(currentCountry.lng);
                    const zoom = parseFloat(currentCountry.zoom);

                    if (isNaN(lat) || isNaN(lng)) {
                        currentType = 'flag';
                        updateDisplayForRound();
                        return;
                    }

                    try {
                        map.invalidateSize();
                        map.flyTo([lat, lng], zoom || 6, { duration: 1.0 });
                        
                        if (mapCircle) {
                            map.removeLayer(mapCircle);
                        }

                        mapCircle = L.circle([lat, lng], {
                            color: '#22c55e', fillColor: '#22c55e', fillOpacity: 0.2, radius: currentCountry.radius || 200000 
                        }).addTo(map);
                    } catch (err) {
                        currentType = 'flag';
                        updateDisplayForRound();
                        return;
                    }
                    
                    forceStopLoading();
                }, 800);
            
            } else if (currentType === 'flag') {
                badgeEl.textContent = currentCountry.isUS ? "ì£¼(State) ê¹ƒë°œ í€´ì¦ˆ" : "êµ­ê¸° í€´ì¦ˆ";
                badgeEl.className = "inline-block px-3 py-1 rounded-full text-xs font-bold text-white bg-red-500 mb-2";
                titleEl.textContent = currentCountry.isUS ? "ğŸ³ï¸ ì–´ëŠ ì£¼ì˜ ê¹ƒë°œì¼ê¹Œìš”?" : "ğŸ³ï¸ ì–´ëŠ ë‚˜ë¼ êµ­ê¸°ì¼ê¹Œìš”?";
                descEl.textContent = "ê¹ƒë°œì„ ë³´ê³  ì •ë‹µì„ ë§ì¶°ë³´ì„¸ìš”!";
                flagContainer.classList.remove('hidden');
                
                flagImg.onload = forceStopLoading;
                flagImg.onerror = () => {
                    console.warn("Flag failed to load");
                    forceStopLoading();
                    flagImg.src = "https://via.placeholder.com/300x200?text=Flag+Not+Found";
                };

                flagImg.src = currentCountry.flagUrl;
                
            } else if (currentType === 'landmark') { 
                badgeEl.textContent = "ëœë“œë§ˆí¬ í€´ì¦ˆ (Beta)";
                badgeEl.className = "inline-block px-3 py-1 rounded-full text-xs font-bold text-white bg-purple-600 mb-2";
                titleEl.textContent = "ğŸ“¸ ì´ ë©‹ì§„ ê³³ì€ ì–´ë””ì¼ê¹Œìš”?";
                descEl.textContent = `íŒíŠ¸: ${capitalKo}(${capitalEn})ì˜ í’ê²½ì…ë‹ˆë‹¤.`;
                
                landmarkContainer.classList.remove('hidden');
                
                // Wikipedia API ì—°ë™
                landmarkImg.onload = () => {
                    forceStopLoading();
                };
                landmarkImg.onerror = handleImageError;

                landmarkImg.src = "https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif";

                // For US states, search for the Capital City or famous landmark, NOT the state name (which might return a map)
                // Using Capital is safer for generating "scenery"
                fetchWikiImage(capitalEn).then(url => {
                    if (url) {
                        landmarkImg.src = url;
                    } else {
                        // Fallback: try searching country/state name if capital fails
                        console.warn("Capital image not found, trying name: " + countryEn);
                        return fetchWikiImage(countryEn);
                    }
                }).then(url => {
                     if (url) {
                        landmarkImg.src = url;
                     } else if (landmarkImg.src.includes('Loading')) {
                        console.warn("No wiki image found.");
                        handleImageError();
                     }
                }).catch(e => {
                    console.error("Wiki fetch error", e);
                    handleImageError();
                });
            
            } else if (currentType === 'brand') {
                badgeEl.textContent = "í‚¤ì›Œë“œ í€´ì¦ˆ";
                badgeEl.className = "inline-block px-3 py-1 rounded-full text-xs font-bold text-white bg-orange-500 mb-2";
                titleEl.textContent = "ğŸ‘œ ìœ ëª… í‚¤ì›Œë“œì˜ ê³ í–¥ì€?";
                descEl.textContent = "ì´ ë¸Œëœë“œë‚˜ í‚¤ì›Œë“œëŠ” ì–´ë”” ê²ƒì¼ê¹Œìš”?";
                textContainer.classList.remove('hidden');
                quizIcon.textContent = "ğŸ”‘";
                
                if (safeBrands.length === 0) {
                    textContent.innerHTML = `<p class="text-sm text-slate-600">ì•„ì§ ë“±ë¡ëœ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.<br/>ì´ë¦„ì„ ë³´ê³  ë§ì¶°ë³´ì„¸ìš”!</p>`;
                } else {
                    const brandList = safeBrands.map(b => `<div class="brand-card">${b}</div>`).join('');
                    textContent.innerHTML = `<div class="flex flex-wrap justify-center items-center">${brandList}</div>`;
                }
                forceStopLoading();
            }
        }

        function createOptions() {
            try {
                let options = [currentCountry];
                // ì˜µì…˜ ìƒì„± ë¡œì§ ê°œì„ : 
                // ë¯¸êµ­ ì£¼ê°€ ì •ë‹µì¼ ê²½ìš°, ì˜¤ë‹µë„ ë¯¸êµ­ ì£¼ ìœ„ì£¼ë¡œ ì„ìœ¼ë©´ ë” í—·ê°ˆë¦¼(ë‚œì´ë„ ìƒìŠ¹)
                let otherCountries;
                
                if (currentCountry.isUS) {
                    // ë¯¸êµ­ ì£¼ë§Œ í•„í„°ë§
                    const usStates = countries.filter(c => c.isUS && c.name !== currentCountry.name);
                    // ë§Œì•½ ë¯¸êµ­ ì£¼ ë°ì´í„°ê°€ ë¶€ì¡±í•˜ë©´ ê·¸ëƒ¥ ì„ìŒ
                    if (usStates.length >= 3) {
                        otherCountries = usStates;
                    } else {
                        otherCountries = countries.filter(c => c.name !== currentCountry.name);
                    }
                } else {
                    otherCountries = countries.filter(c => c.name !== currentCountry.name);
                }

                const shuffledOthers = otherCountries.sort(() => 0.5 - Math.random()).slice(0, 3);
                options = options.concat(shuffledOthers);
                options.sort(() => 0.5 - Math.random());

                const container = document.getElementById('options-container');
                options.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = "option-btn bg-white hover:bg-slate-50 border-2 border-slate-200 text-slate-700 font-semibold py-4 px-2 rounded-lg shadow-sm transition-all active:scale-95 text-sm sm:text-base break-keep";
                    
                    const namePair = splitNamePair(option.name);
                    btn.textContent = namePair.ko;
                    
                    btn.onclick = () => checkAnswer(option, btn);
                    container.appendChild(btn);
                });
            } catch (error) {
                console.error("Error creating options:", error);
            }
        }

        function checkAnswer(selected, btnElement) {
            if (isAnswered) return;
            isAnswered = true;
            const container = document.getElementById('options-container');

            const selectedNamePair = splitNamePair(selected.name);
            const currentNamePair = splitNamePair(currentCountry.name);

            if (selected.name === currentCountry.name) {
                score += 10;
                document.getElementById('score').textContent = score;
                btnElement.classList.add('bg-green-100', 'border-green-500', 'text-green-700', 'correct-anim');
                
                setTimeout(() => {
                    openModal(currentCountry);
                }, 500); 

            } else {
                btnElement.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
                
                const buttons = container.getElementsByTagName('button');
                for (let btn of buttons) {
                    if (btn.textContent === currentNamePair.ko) {
                        btn.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
                    }
                }
                setTimeout(() => {
                    nextRound();
                }, 2000);
            }
            container.classList.add('pointer-events-none');
        }

        function openModal(country) {
            const modal = document.getElementById('video-modal');
            const iframe = document.getElementById('reward-video');
            const title = document.getElementById('modal-title');
            const desc = document.getElementById('modal-desc');
            const fallbackLink = document.getElementById('video-fallback-link');

            const namePair = splitNamePair(country.name);
            const capitalPair = splitNamePair(country.capital);
            const countryKo = namePair.ko;
            const countryEn = namePair.en;
            const capitalKo = capitalPair.ko;

            title.textContent = `ğŸ‰ ${countryKo} ë„ì°©!`;

            let videoId = country.videoId;
            const isPlaceholder = !videoId || videoId.includes('1-2-3');

            // US State Description logic
            if (country.isUS) {
                desc.textContent = `ë¯¸êµ­ ${countryKo}ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!\nì£¼ë„(Capital): ${capitalKo}`;
            } else {
                desc.textContent = `ìˆ˜ë„: ${capitalKo}\níˆ¬ì–´ë©”ì´ì»¤ê°€ ì—„ì„ í•œ ì—¬í–‰ì§€ì…ë‹ˆë‹¤.`;
            }

            if (isPlaceholder) {
                videoId = "P_upO4tqLTk"; 
            }

            iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&rel=0&showinfo=0&modestbranding=1`;
            
            if (fallbackLink) {
                if (!isPlaceholder) {
                     fallbackLink.href = `https://www.youtube.com/watch?v=${videoId}`;
                     fallbackLink.textContent = "ğŸ“º ì˜ìƒì´ ì•ˆ ë‚˜ì˜¤ë‚˜ìš”? ìœ íŠœë¸Œ ì•±ì—ì„œ ë³´ê¸°";
                } else {
                     const query = countryEn || countryKo;
                     fallbackLink.href = `https://www.youtube.com/results?search_query=travel+${encodeURIComponent(query)}`;
                     fallbackLink.textContent = "ğŸ“º ë” ë§ì€ ì˜ìƒ ê²€ìƒ‰í•˜ê¸°";
                }
            }

            modal.classList.remove('hidden');
        }

        function closeModal() {
            const modal = document.getElementById('video-modal');
            const iframe = document.getElementById('reward-video');
            iframe.src = ""; 
            modal.classList.add('hidden');
            
            if(isAnswered) {
                 nextRound();
            }
        }

        window.onload = initMap;
    </script>
</body>
</html>
