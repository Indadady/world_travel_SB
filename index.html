<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íˆ¬ì–´ë©”ì´ì»¤ - ì„¸ê³„ ì—¬í–‰ ë§ˆìŠ¤í„° (Hell Mode + Rare Flags)</title>
    
    <!-- ğŸš¨ Google Analytics (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JLH9GD9SVR"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-JLH9GD9SVR');
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=Roboto+Slab:wght@700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        #map { height: 350px; width: 100%; border-radius: 0.5rem; z-index: 1; }
        
        .quiz-img { 
            height: 280px; 
            width: 100%; 
            object-fit: contain;
            border-radius: 0.5rem;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
        }

        .logo-img {
            max-height: 180px;
            max-width: 80%;
            object-fit: contain;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }
        
        .correct-anim { animation: bounce 0.5s; }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .modal-overlay { background-color: rgba(0, 0, 0, 0.85); }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: #000; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* 6ì§€ì„ ë‹¤í˜•ì„ ìœ„í•œ ê·¸ë¦¬ë“œ ì¡°ì • */
        .option-btn { min-height: 60px; font-size: 0.95rem; }

        .brand-card {
            font-family: 'Roboto Slab', serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            color: #343a40;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1.0rem;
            margin: 0.2rem;
            border-radius: 6px;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            font-size: 0.9rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col items-center">

    <!-- í—¤ë” -->
    <header class="w-full bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgHfgIX70O5k6Anuo0UgALIdaG9jSga9auHu3uyz0uEirylGPAJnjN_qQbvEGMUvPqUQf_g9FMNUHRxlDcUBf4vZ3Mpy4TnA9WxbmzWYK11gt2zuy_Irl4wctNFjcjLyPo0GPXV792o_J7L9guRMuDfeC1gy7USwywjYbECZgzcsHybuGRRAXAnO1eNmP8/s320/logo.png" 
                 alt="Tourmaker Logo" class="h-10 w-auto object-contain">
            <div class="flex flex-col">
                <h1 class="text-lg sm:text-xl font-bold text-slate-800 leading-tight">World Biz <span class="text-red-600">Master</span></h1>
                <span class="text-xs text-slate-500">Hell Mode (6 Choices)</span>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-slate-600 font-medium">
                LV.<span id="level-display" class="font-bold text-slate-800">1</span>
            </div>
            <div class="text-slate-600 font-medium">
                Score: <span id="score" class="text-blue-600 font-bold text-lg">0</span>
            </div>
        </div>
    </header>

    <!-- ë©”ì¸ ê²Œì„ ì˜ì—­ -->
    <main class="w-full max-w-3xl p-4 flex-grow flex flex-col gap-4">
        
        <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 text-center relative overflow-hidden">
            <div id="us-special-badge" class="hidden absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-bl-lg animate-pulse">
                ğŸ‡ºğŸ‡¸ ë¯¸êµ­ íŠ¹ë³„í¸
            </div>
            <span id="quiz-type-badge" class="inline-block px-3 py-1 rounded-full text-xs font-bold text-white bg-blue-500 mb-2">Quiz</span>
            <h2 id="question-title" class="text-xl font-black text-slate-800 mb-1">ì—¬í–‰ ì¤€ë¹„ ì¤‘...</h2>
            <p id="question-desc" class="text-sm text-slate-500">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
        </div>

        <div class="bg-white p-2 rounded-lg shadow-lg border border-slate-300 relative min-h-[300px] flex items-center justify-center overflow-hidden">
            
            <div id="map-container" class="w-full h-full hidden">
                <div id="map"></div>
                <div class="absolute bottom-4 right-4 bg-white/90 px-3 py-1 rounded shadow text-xs font-bold text-slate-600 z-[1000]">
                    <span class="inline-block w-3 h-3 rounded-full bg-green-500 opacity-50 mr-1 align-middle"></span>ì˜ì—­ íŒíŠ¸
                </div>
            </div>

            <div id="flag-container" class="w-full h-full hidden flex-col items-center justify-center p-4 bg-slate-50">
                <img id="flag-image" src="" alt="Flag" class="quiz-img">
            </div>

            <div id="landmark-container" class="w-full h-full hidden flex-col items-center justify-center p-2 bg-slate-100">
                <img id="landmark-image" src="" alt="Landmark" class="quiz-img w-full object-cover rounded-lg shadow-md" style="object-fit: cover;">
                <div class="mt-2 text-xs text-slate-400 font-medium">AI Generated Landmark (Preview)</div>
            </div>

            <div id="text-quiz-container" class="w-full min-h-[250px] hidden flex flex-col items-center justify-center p-6 bg-gradient-to-br from-indigo-50 to-blue-50 text-center">
                <div class="text-6xl mb-4" id="quiz-icon">ğŸ‘œ</div>
                <div id="text-quiz-content" class="w-full"></div>
            </div>

            <div id="logo-quiz-container" class="w-full h-full hidden flex-col items-center justify-center p-6 bg-white text-center">
                 <div class="text-sm font-bold text-slate-500 mb-4 tracking-widest">HIDDEN CHAMPION</div>
                 <div class="flex-grow flex items-center justify-center w-full p-4 border border-slate-100 rounded-xl bg-slate-50 shadow-inner">
                    <img id="company-logo" src="" alt="Company Logo" class="logo-img">
                 </div>
                 <div class="mt-4 text-xs text-slate-400">ì´ ë¡œê³ ì˜ ê¸°ì—…ì€ ì–´ëŠ ë‚˜ë¼ ê²ƒì¼ê¹Œìš”?</div>
            </div>

            <div id="loading" class="absolute inset-0 bg-white/95 z-20 flex flex-col items-center justify-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600 mb-4"></div>
                <span class="text-blue-600 font-bold text-lg">ë‹¤ìŒ ë¬¸ì œ ë¡œë”© ì¤‘...</span>
                <p class="text-xs text-slate-400 mt-2">í¬ê·€ êµ­ê¸° ë°ì´í„° ë¡œë”© ì¤‘ (3ì´ˆ ì œí•œ)</p>
                <button onclick="forceStopLoading()" class="mt-4 px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded text-slate-600 text-xs font-bold">
                    ë©ˆì·„ë‚˜ìš”? ì—¬ê¸° í´ë¦­
                </button>
            </div>
        </div>

        <!-- 6ì§€ì„ ë‹¤í˜• ê·¸ë¦¬ë“œ (ëª¨ë°”ì¼ 2ì—´, PC 3ì—´) -->
        <div id="options-container" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mt-2 min-h-[150px]"></div>

    </main>

    <!-- ë¹„ë””ì˜¤ ëª¨ë‹¬ -->
    <div id="video-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center">
        <div class="absolute inset-0 modal-overlay backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="relative w-11/12 max-w-2xl bg-white rounded-xl shadow-2xl overflow-hidden border-4 border-white flex flex-col max-h-[90vh]">
            <div class="bg-blue-600 text-white p-3 flex justify-between items-center shrink-0">
                <h3 class="font-bold flex items-center gap-2">
                    <span>ğŸ‰ ì •ë‹µ! íˆ¬ì–´ë©”ì´ì»¤ ì¶”ì²œ ì—¬í–‰ì§€</span>
                </h3>
                <button onclick="closeModal()" class="hover:bg-blue-700 rounded-full p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="video-container bg-black shrink-0">
                <iframe id="reward-video" src="" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
            
            <div class="p-4 text-center bg-slate-50 flex flex-col gap-3 overflow-y-auto">
                <p class="text-slate-800 font-bold text-lg" id="modal-title">êµ­ê°€ ì´ë¦„</p>
                <p class="text-slate-600 text-sm whitespace-pre-wrap" id="modal-desc">ì„¤ëª…</p>
                
                <a id="video-fallback-link" href="#" target="_blank" class="block w-full py-2 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg text-sm font-bold transition-colors">
                    ğŸ“º ì˜ìƒì´ ì•ˆ ë‚˜ì˜¤ë‚˜ìš”? ìœ íŠœë¸Œ ì•±ì—ì„œ ë³´ê¸° (í´ë¦­)
                </a>

                <button onclick="closeModal()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition-all transform hover:scale-105 mt-2">
                    ë‹¤ìŒ ë¬¸ì œ í’€ê¸° (Next Level) â¡
                </button>
            </div>
        </div>
    </div>

    <!-- í‘¸í„° -->
    <footer class="w-full bg-slate-800 text-slate-300 p-6 text-center mt-auto">
        <p class="font-bold text-lg mb-1">Tourmaker Smart Guide</p>
        <p class="text-sm opacity-75">Designed by <span class="text-yellow-400 font-bold">Sebastian & Sungbin</span></p>
        <p class="text-xs mt-2 opacity-50">Since 2019 â€¢ Gangwon-do, Korea</p>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // ë‚œì´ë„: HELL + RARE FLAGS
        const countries = [
            // ==========================================
            // [SECTION 1] USA SPECIAL (Updated Videos)
            // ==========================================
            { 
                name: "ë¯¸êµ­ (USA)", capital: "ì›Œì‹±í„´ D.C.", brands: ["Apple", "Google", "Tesla", "Nvidia"], 
                lat: 39.8, lng: -98.5, zoom: 4, radius: 2500000, 
                flagUrl: "https://flagcdn.com/h240/us.png", videoId: "iq5KTD0_bck",
                logos: [
                    "https://upload.wikimedia.org/wikipedia/commons/2/f4/Google_2015_logo.svg",
                    "https://upload.wikimedia.org/wikipedia/commons/e/e8/Tesla_logo.png",
                    "https://upload.wikimedia.org/wikipedia/commons/a/a4/NVIDIA_logo.svg",
                    "https://upload.wikimedia.org/wikipedia/commons/0/0e/Rivian_logo.svg"
                ]
            },
            { 
                name: "ìº˜ë¦¬í¬ë‹ˆì•„ (California)", capital: "ìƒˆí¬ë¼ë©˜í† ", brands: ["Hollywood", "Silicon Valley"], 
                lat: 36.77, lng: -119.41, zoom: 6, radius: 250000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/0/01/Flag_of_California.svg", 
                videoId: "_GBozUXgFe0", // [Updated]
                isUS: true 
            },
            { 
                name: "ì›Œì‹±í„´ ì£¼ (Washington)", capital: "ì˜¬ë¦¼í”¼ì•„", brands: ["Starbucks", "Microsoft", "Amazon HQ"], 
                lat: 47.75, lng: -120.74, zoom: 7, radius: 150000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/5/54/Flag_of_Washington.svg", 
                videoId: "laCEqO_HBKo", // [Updated]
                isUS: true 
            },
            { 
                name: "í•˜ì™€ì´ (Hawaii)", capital: "í˜¸ë†€ë£°ë£¨", brands: ["Waikiki", "Aloha"], 
                lat: 20.79, lng: -156.33, zoom: 7, radius: 100000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/e/ef/Flag_of_Hawaii.svg", 
                videoId: "qkCoDOQFE2Q", // [Updated]
                isUS: true 
            },
            { 
                name: "ë„¤ë°”ë‹¤ (Nevada)", capital: "ì¹´ìŠ¨ì‹œí‹°", brands: ["Las Vegas", "Desert"], 
                lat: 38.80, lng: -116.41, zoom: 6, radius: 200000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/f/f1/Flag_of_Nevada.svg", 
                videoId: "sychpKq7Ioc", videoStart: 9,
                isUS: true 
            },
            { 
                name: "í…ì‚¬ìŠ¤ (Texas)", capital: "ì˜¤ìŠ¤í‹´", brands: ["NASA Houston", "BBQ"], 
                lat: 31.96, lng: -99.90, zoom: 6, radius: 300000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/f/f7/Flag_of_Texas.svg", 
                videoId: "KzX9kJumv9A",
                isUS: true 
            },

            // ==========================================
            // [SECTION 2] RARE & UNKNOWN FLAGS (HELL)
            // ==========================================
            { 
                name: "í‚¤ë¥´ê¸°ìŠ¤ìŠ¤íƒ„ (Kyrgyzstan)", capital: "ë¹„ìŠˆì¼€í¬", brands: ["Yurt", "Central Asia", "Mountains"], 
                lat: 41.2, lng: 74.7, zoom: 6, radius: 300000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/c/c7/Flag_of_Kyrgyzstan.svg", 
                videoId: "3k5l6m7n8o9" // Placeholder
            },
            { 
                name: "ë¶€íƒ„ (Bhutan)", capital: "íŒ€í‘¸", brands: ["Dragon", "Happiness", "Himalayas"], 
                lat: 27.5, lng: 90.4, zoom: 8, radius: 100000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/9/91/Flag_of_Bhutan.svg", 
                videoId: "e2f3g4h5i6j" 
            },
            { 
                name: "ì„¸ì´ì…¸ (Seychelles)", capital: "ë¹…í† ë¦¬ì•„", brands: ["Paradise", "Coco de Mer"], 
                lat: -4.6, lng: 55.4, zoom: 9, radius: 50000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/f/fc/Flag_of_Seychelles.svg", 
                videoId: "7k8l9m0n1o2" 
            },
            { 
                name: "ì—ìŠ¤ì™€í‹°ë‹ˆ (Eswatini)", capital: "ìŒë°”ë°”ë„¤", brands: ["Kingdom", "Culture"], 
                lat: -26.5, lng: 31.5, zoom: 9, radius: 50000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/f/fb/Flag_of_Eswatini.svg", 
                videoId: "1a2b3c4d5e6" 
            },
            { 
                name: "ì„¸ì¸íŠ¸ë£¨ì‹œì•„ (Saint Lucia)", capital: "ìºìŠ¤íŠ¸ë¦¬ìŠ¤", brands: ["Pitons", "Caribbean"], 
                lat: 13.9, lng: -60.9, zoom: 10, radius: 30000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/9/9f/Flag_of_Saint_Lucia.svg", 
                videoId: "f1g2h3i4j5k" 
            },
            { 
                name: "ì•¤í‹°ê°€ ë°”ë¶€ë‹¤ (Antigua & Barbuda)", capital: "ì„¸ì¸íŠ¸ì¡´ìŠ¤", brands: ["365 Beaches", "Cricket"], 
                lat: 17.0, lng: -61.8, zoom: 10, radius: 30000, 
                flagUrl: "https://upload.wikimedia.org/wikipedia/commons/8/89/Flag_of_Antigua_and_Barbuda.svg", 
                videoId: "x1y2z3a4b5c" 
            },

            // ==========================================
            // [SECTION 3] UPDATED COUNTRIES (Video Updated)
            // ==========================================
            { 
                name: "ì‚°ë§ˆë¦¬ë…¸ (San Marino)", capital: "ì‚°ë§ˆë¦¬ë…¸", brands: ["Stamps", "Oldest Republic"], 
                lat: 43.94, lng: 12.45, zoom: 12, radius: 5000, 
                flagUrl: "https://flagcdn.com/h240/sm.png", 
                videoId: "Aisq9uU4OLQ", videoStart: 2 // [Updated] Start at 2s
            },
            { 
                name: "ì¸ë„ (India)", capital: "ë‰´ë¸ë¦¬", brands: ["Tata", "Curry", "Taj Mahal"], 
                lat: 20.5, lng: 78.9, zoom: 5, radius: 1500000, 
                flagUrl: "https://flagcdn.com/h240/in.png", 
                videoId: "wAD9uO9YAQw", // [Updated]
                logos: ["https://upload.wikimedia.org/wikipedia/commons/8/8e/Tata_logo.svg"] 
            },
            { 
                name: "í•€ë€ë“œ (Finland)", capital: "í—¬ì‹±í‚¤", brands: ["Nokia", "Angry Birds"], 
                lat: 61.9, lng: 25.7, zoom: 5, radius: 300000, 
                flagUrl: "https://flagcdn.com/h240/fi.png", 
                videoId: "o5y7yRsKYxU", // [Updated]
                logos: ["https://upload.wikimedia.org/wikipedia/commons/0/02/Nokia_wordmark.svg"] 
            },
            { 
                name: "ë´ë§ˆí¬ (Denmark)", capital: "ì½”íœí•˜ê²", brands: ["LEGO", "Maersk", "Hygge"], 
                lat: 56.2, lng: 9.5, zoom: 7, radius: 150000, 
                flagUrl: "https://flagcdn.com/h240/dk.png", 
                videoId: "OkkvuIG-rCE", // [Updated]
                logos: ["https://upload.wikimedia.org/wikipedia/commons/2/24/LEGO_logo.svg"] 
            },

            // ==========================================
            // [SECTION 4] EXISTING TECH & OTHERS
            // ==========================================
            { name: "ëŒ€ë§Œ (Taiwan)", capital: "íƒ€ì´ë² ì´", brands: ["TSMC", "ASUS"], lat: 23.69, lng: 120.96, zoom: 7, radius: 100000, flagUrl: "https://flagcdn.com/h240/tw.png", videoId: "3k5l6m7n8o9", logos: ["https://upload.wikimedia.org/wikipedia/commons/2/29/TSMC_logo.svg"] },
            { name: "ë„¤ëœë€ë“œ (Netherlands)", capital: "ì•”ìŠ¤í…Œë¥´ë‹´", brands: ["ASML", "Philips"], lat: 52.1, lng: 5.2, zoom: 7, radius: 150000, flagUrl: "https://flagcdn.com/h240/nl.png", videoId: "e2f3g4h5i6j", logos: ["https://upload.wikimedia.org/wikipedia/commons/2/23/ASML_logo.svg"] },
            { name: "ì¼ë³¸ (Japan)", capital: "ë„ì¿„", brands: ["Sony", "Nintendo", "Toyota"], lat: 36.2, lng: 138.2, zoom: 5, radius: 600000, flagUrl: "https://flagcdn.com/h240/jp.png", videoId: "nhXC2YdyjvU", logos: ["https://upload.wikimedia.org/wikipedia/commons/c/c3/Sony_logo.svg"] },
            { name: "ì¤‘êµ­ (China)", capital: "ë² ì´ì§•", brands: ["Alibaba", "DJI", "BYD"], lat: 35.8, lng: 104.1, zoom: 4, radius: 2000000, flagUrl: "https://flagcdn.com/h240/cn.png", videoId: "8lq3yG_Hw4E", logos: ["https://upload.wikimedia.org/wikipedia/commons/a/ad/DJI_Logo.svg"] },
            { name: "ëŒ€í•œë¯¼êµ­ (Korea)", capital: "ì„œìš¸", brands: ["Samsung", "Hyundai", "BTS"], lat: 36.5, lng: 127.8, zoom: 6, radius: 250000, flagUrl: "https://flagcdn.com/h240/kr.png", videoId: "3P1CnWI62Ik", logos: ["https://upload.wikimedia.org/wikipedia/commons/2/24/Samsung_Logo.svg"] },
            { name: "ì˜êµ­ (UK)", capital: "ëŸ°ë˜", brands: ["BBC", "Dyson"], lat: 55.3, lng: -3.4, zoom: 6, radius: 300000, flagUrl: "https://flagcdn.com/h240/gb.png", videoId: "i9E_Blai8vk", logos: ["https://upload.wikimedia.org/wikipedia/commons/4/42/BBC_Logo_2021.svg"] },
            { name: "í”„ë‘ìŠ¤ (France)", capital: "íŒŒë¦¬", brands: ["Louis Vuitton", "Airbus"], lat: 46.2, lng: 2.2, zoom: 6, radius: 450000, flagUrl: "https://flagcdn.com/h240/fr.png", videoId: "-q6iol-BEEw", logos: ["https://upload.wikimedia.org/wikipedia/commons/c/c8/Louis_Vuitton_LV_logo.png"] },
            { name: "ë…ì¼ (Germany)", capital: "ë² ë¥¼ë¦°", brands: ["BMW", "SAP"], lat: 51.1, lng: 10.4, zoom: 6, radius: 350000, flagUrl: "https://flagcdn.com/h240/de.png", videoId: "8DEozJok3U8", logos: ["https://upload.wikimedia.org/wikipedia/commons/4/44/BMW.svg"] },
            { name: "ë‚˜ìš°ë£¨ (Nauru)", capital: "ì•¼ë Œ", brands: ["Phosphate"], lat: -0.52, lng: 166.93, zoom: 13, radius: 5000, flagUrl: "https://upload.wikimedia.org/wikipedia/commons/3/30/Flag_of_Nauru.svg", videoId: "S8_n4xG0wT4" },
            { name: "ì½”ì†Œë³´ (Kosovo)", capital: "í”„ë¦¬ìŠˆí‹°ë‚˜", brands: ["Newborn"], lat: 42.6, lng: 20.9, zoom: 8, radius: 40000, flagUrl: "https://upload.wikimedia.org/wikipedia/commons/1/1f/Flag_of_Kosovo.svg", videoId: "YFI7McdQhGc" }
        ];

        let map;
        let mapCircle;
        let currentRound = 0;
        let score = 0;
        let currentCountry = null;
        let currentType = ''; 
        let isAnswered = false;
        let safeTimer = null;
        let prevCountryIndex = null;
        let prevType = null;

        function splitNamePair(fullText) {
            if (!fullText) return { ko: "Unknown", en: "" };
            if (!fullText.includes('(')) return { ko: fullText.trim(), en: "" };
            const [koPart, rest] = fullText.split('(');
            const enPart = rest.replace(')', '').trim();
            return { ko: koPart.trim(), en: enPart };
        }

        async function fetchWikiImage(query) {
            try {
                if (!query) return null;
                const url = `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(query)}&prop=pageimages&format=json&pithumbsize=600&origin=*&redirects`;
                const res = await fetch(url);
                const data = await res.json();
                if (!data || !data.query || !data.query.pages) return null;
                const pages = data.query.pages;
                const pageId = Object.keys(pages)[0];
                if (pageId === "-1") return null; 
                if (pages[pageId].thumbnail && pages[pageId].thumbnail.source) {
                    return pages[pageId].thumbnail.source;
                }
                return null;
            } catch (e) {
                console.error("Wiki fetch error:", e);
                return null;
            }
        }

        function initMap() {
            try {
                map = L.map('map', {
                    zoomControl: true, attributionControl: false,
                    dragging: true, scrollWheelZoom: true, doubleClickZoom: true
                }).setView([39.8, -98.5], 3); 

                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri', maxZoom: 17
                }).addTo(map);

                startGame();
            } catch (error) {
                console.error("Map initialization failed:", error);
                document.getElementById('question-title').textContent = "ì˜¤ë¥˜ ë°œìƒ";
                document.getElementById('question-desc').textContent = "ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.";
            }
        }

        function startGame() {
            nextRound();
        }

        function forceStopLoading() {
            const loader = document.getElementById('loading');
            if (loader && !loader.classList.contains('hidden')) {
                loader.classList.add('hidden');
            }
        }

        function handleImageError() {
            console.warn("Image failed, falling back to flag quiz");
            forceStopLoading(); 
            currentType = 'flag';
            updateDisplayForRound(); 
        }

        function nextRound() {
            if (safeTimer) clearTimeout(safeTimer);
            document.getElementById('loading').classList.remove('hidden');
            safeTimer = setTimeout(forceStopLoading, 4000); 

            const modal = document.getElementById('video-modal');
            const iframe = document.getElementById('reward-video');
            if(iframe) iframe.src = ""; 
            if(modal) modal.classList.add('hidden');

            isAnswered = false;
            currentRound++;
            document.getElementById('level-display').textContent = currentRound;
            
            const container = document.getElementById('options-container');
            if(container) {
                container.innerHTML = '';
                container.classList.remove('opacity-50', 'pointer-events-none');
            }
            
            if (map && mapCircle) {
                map.removeLayer(mapCircle);
                mapCircle = null;
            }
            
            // íƒ€ì… ì„ íƒ ë¡œì§
            let newType;
            let tempCountry;
            
            let randomIndex;
            do {
                randomIndex = Math.floor(Math.random() * countries.length);
            } while (countries.length > 1 && randomIndex === prevCountryIndex);
            
            tempCountry = countries[randomIndex];
            
            let availableTypes = ['map', 'flag', 'brand'];
            
            // ë¡œê³ ê°€ ìˆìœ¼ë©´ ë¡œê³  í€´ì¦ˆ ë¹„ì¤‘ UP
            if (tempCountry.logos && tempCountry.logos.length > 0) {
                availableTypes.push('logo'); 
                availableTypes.push('logo'); 
            }
            
            if (tempCountry.capital) availableTypes.push('landmark');

            do {
                newType = availableTypes[Math.floor(Math.random() * availableTypes.length)];
            } while (availableTypes.length > 1 && newType === prevType);

            currentType = newType;
            prevType = newType;
            prevCountryIndex = randomIndex;
            currentCountry = tempCountry;

            try {
                updateDisplayForRound();
            } catch (error) {
                currentType = 'flag';
                updateDisplayForRound();
            }

            createOptions();

            setTimeout(() => {
                forceStopLoading();
            }, 4000);
        }

        function updateDisplayForRound() {
            const titleEl = document.getElementById('question-title');
            const descEl = document.getElementById('question-desc');
            const badgeEl = document.getElementById('quiz-type-badge');
            const usBadge = document.getElementById('us-special-badge');
            
            const mapContainer = document.getElementById('map-container');
            const flagContainer = document.getElementById('flag-container');
            const landmarkContainer = document.getElementById('landmark-container'); 
            const textContainer = document.getElementById('text-quiz-container');
            const logoContainer = document.getElementById('logo-quiz-container');
            
            const textContent = document.getElementById('text-quiz-content');
            const flagImg = document.getElementById('flag-image');
            const landmarkImg = document.getElementById('landmark-image'); 
            const logoImg = document.getElementById('company-logo');

            // í•¸ë“¤ëŸ¬ ì´ˆê¸°í™”
            landmarkImg.onload = null;
            landmarkImg.onerror = null;
            flagImg.onload = null;
            flagImg.onerror = null;
            logoImg.onload = null;
            logoImg.onerror = null;

            mapContainer.classList.add('hidden');
            flagContainer.classList.add('hidden');
            landmarkContainer.classList.add('hidden'); 
            textContainer.classList.add('hidden');
            logoContainer.classList.add('hidden');

            if (currentCountry.isUS) {
                usBadge.classList.remove('hidden');
            } else {
                usBadge.classList.add('hidden');
            }

            const namePair = splitNamePair(currentCountry.name);
            const capitalPair = splitNamePair(currentCountry.capital);
            const countryKo = namePair.ko;
            const countryEn = namePair.en || 'Country';
            const capitalKo = capitalPair.ko;
            const capitalEn = capitalPair.en || capitalPair.ko;
            const safeBrands = currentCountry.brands || [];

            if (currentType === 'map') {
                badgeEl.textContent = currentCountry.isUS ? "ë¯¸êµ­ ì§€ë¦¬ í€´ì¦ˆ" : "ì„¸ê³„ ì§€ë¦¬ í€´ì¦ˆ";
                badgeEl.className = "inline-block px-3 py-1 rounded-full text-xs font-bold text-white bg-green-600 mb-2";
                titleEl.textContent = "ğŸŒ ì´ê³³ì€ ì–´ë””ì¼ê¹Œìš”?";
                descEl.textContent = "ì´ˆë¡ìƒ‰ ì˜ì—­ì„ ë³´ê³  ì •ë‹µì„ ë§ì¶°ë³´ì„¸ìš”!";
                mapContainer.classList.remove('hidden');
                
                setTimeout(() => {
                    if (!map) return;
                    const lat = parseFloat(currentCountry.lat);
                    const lng = parseFloat(currentCountry.lng);
                    const zoom = parseFloat(currentCountry.zoom);
                    if (isNaN(lat) || isNaN(lng)) return;

                    try {
                        map.invalidateSize();
                        map.flyTo([lat, lng], zoom || 6, { duration: 1.0 });
                        if (mapCircle) map.removeLayer(mapCircle);
                        mapCircle = L.circle([lat, lng], {
                            color: '#22c55e', fillColor: '#22c55e', fillOpacity: 0.2, radius: currentCountry.radius || 200000 
                        }).addTo(map);
                    } catch (err) {}
                    forceStopLoading();
                }, 800);
            
            } else if (currentType === 'flag') {
                badgeEl.textContent = "êµ­ê¸° í€´ì¦ˆ";
                badgeEl.className = "inline-block px-3 py-1 rounded-full text-xs font-bold text-white bg-red-500 mb-2";
                titleEl.textContent = "ğŸ³ï¸ ì–´ëŠ ë‚˜ë¼ êµ­ê¸°ì¼ê¹Œìš”?";
                descEl.textContent = "ê¹ƒë°œì„ ë³´ê³  ì •ë‹µì„ ë§ì¶°ë³´ì„¸ìš”!";
                flagContainer.classList.remove('hidden');
                flagImg.onload = forceStopLoading;
                flagImg.onerror = () => { flagImg.src = "https://via.placeholder.com/300x200"; forceStopLoading(); };
                flagImg.src = currentCountry.flagUrl;
                
            } else if (currentType === 'landmark') { 
                badgeEl.textContent = "ëœë“œë§ˆí¬ í€´ì¦ˆ";
                badgeEl.className = "inline-block px-3 py-1 rounded-full text-xs font-bold text-white bg-purple-600 mb-2";
                titleEl.textContent = "ğŸ“¸ ì´ ë©‹ì§„ ê³³ì€ ì–´ë””ì¼ê¹Œìš”?";
                descEl.textContent = `íŒíŠ¸: ${capitalKo}(${capitalEn})ì˜ í’ê²½ì…ë‹ˆë‹¤.`;
                landmarkContainer.classList.remove('hidden');
                
                landmarkImg.onload = forceStopLoading;
                landmarkImg.onerror = handleImageError;
                landmarkImg.src = "https://upload.wikimedia.org/wikipedia/commons/b/b1/Loading_icon.gif";

                fetchWikiImage(capitalEn).then(url => {
                    if (url) landmarkImg.src = url;
                    else fetchWikiImage(countryEn).then(u => { if(u) landmarkImg.src = u; else handleImageError(); });
                });
            
            } else if (currentType === 'brand') {
                badgeEl.textContent = "í‚¤ì›Œë“œ í€´ì¦ˆ";
                badgeEl.className = "inline-block px-3 py-1 rounded-full text-xs font-bold text-white bg-orange-500 mb-2";
                titleEl.textContent = "ğŸ‘œ ìœ ëª… í‚¤ì›Œë“œì˜ ê³ í–¥ì€?";
                descEl.textContent = "ì´ ë¸Œëœë“œë‚˜ í‚¤ì›Œë“œëŠ” ì–´ë”” ê²ƒì¼ê¹Œìš”?";
                textContainer.classList.remove('hidden');
                
                if (safeBrands.length === 0) {
                    textContent.innerHTML = `<p class="text-sm text-slate-600">íŒíŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
                } else {
                    const brandList = safeBrands.map(b => `<div class="brand-card">${b}</div>`).join('');
                    textContent.innerHTML = `<div class="flex flex-wrap justify-center items-center">${brandList}</div>`;
                }
                forceStopLoading();

            } else if (currentType === 'logo') {
                badgeEl.textContent = "ê¸°ì—… ë¡œê³  í€´ì¦ˆ";
                badgeEl.className = "inline-block px-3 py-1 rounded-full text-xs font-bold text-white bg-indigo-600 mb-2";
                titleEl.textContent = "ğŸ¢ ì´ ë¡œê³ ì˜ ì£¼ì¸ì€?";
                descEl.textContent = "ì „ ì„¸ê³„ íˆë“  ì±”í”¼ì–¸ ê¸°ì—…ì„ ë§ì¶°ë³´ì„¸ìš”!";
                logoContainer.classList.remove('hidden');
                
                logoImg.onload = forceStopLoading;
                logoImg.onerror = () => { 
                    console.warn("Logo load failed, fallback to brand text");
                    logoContainer.classList.add('hidden');
                    currentType = 'brand'; // fallback
                    updateDisplayForRound();
                };

                const randomLogo = currentCountry.logos[Math.floor(Math.random() * currentCountry.logos.length)];
                logoImg.src = randomLogo;
            }
        }

        function createOptions() {
            try {
                let options = [currentCountry];
                let otherCountries;
                
                if (currentCountry.isUS) {
                    const usStates = countries.filter(c => c.isUS && c.name !== currentCountry.name);
                    otherCountries = usStates.length >= 6 ? usStates : countries.filter(c => c.name !== currentCountry.name);
                } else {
                    otherCountries = countries.filter(c => c.name !== currentCountry.name);
                }

                // 6ì§€ì„ ë‹¤í˜• (ì •ë‹µ 1 + ì˜¤ë‹µ 5)
                const shuffledOthers = otherCountries.sort(() => 0.5 - Math.random()).slice(0, 5);
                options = options.concat(shuffledOthers);
                options.sort(() => 0.5 - Math.random());

                const container = document.getElementById('options-container');
                options.forEach(option => {
                    const btn = document.createElement('button');
                    btn.className = "option-btn bg-white hover:bg-slate-50 border-2 border-slate-200 text-slate-700 font-semibold py-3 px-2 rounded-lg shadow-sm transition-all active:scale-95 text-sm break-keep";
                    const namePair = splitNamePair(option.name);
                    btn.textContent = namePair.ko;
                    btn.onclick = () => checkAnswer(option, btn);
                    container.appendChild(btn);
                });
            } catch (error) { console.error(error); }
        }

        function checkAnswer(selected, btnElement) {
            if (isAnswered) return;
            isAnswered = true;
            const container = document.getElementById('options-container');

            if (selected.name === currentCountry.name) {
                score += 10;
                document.getElementById('score').textContent = score;
                btnElement.classList.add('bg-green-100', 'border-green-500', 'text-green-700', 'correct-anim');
                setTimeout(() => openModal(currentCountry), 500); 
            } else {
                btnElement.classList.add('bg-red-100', 'border-red-500', 'text-red-700');
                const namePair = splitNamePair(currentCountry.name);
                const buttons = container.getElementsByTagName('button');
                for (let btn of buttons) {
                    if (btn.textContent === namePair.ko) {
                        btn.classList.add('bg-green-100', 'border-green-500', 'text-green-700');
                    }
                }
                setTimeout(() => nextRound(), 2000);
            }
            container.classList.add('pointer-events-none');
        }

        function openModal(country) {
            const modal = document.getElementById('video-modal');
            const iframe = document.getElementById('reward-video');
            const title = document.getElementById('modal-title');
            const desc = document.getElementById('modal-desc');
            const fallbackLink = document.getElementById('video-fallback-link');

            const namePair = splitNamePair(country.name);
            const countryKo = namePair.ko;
            const countryEn = namePair.en;

            title.textContent = `ğŸ‰ ${countryKo} ì •ë‹µ!`;
            
            if (currentType === 'logo') {
                desc.textContent = `ëŒ€ë‹¨í•©ë‹ˆë‹¤! ì´ ê¸°ì—…ì€ ${countryKo}ì˜ ìë¶€ì‹¬ì…ë‹ˆë‹¤.`;
            } else if (country.isUS) {
                desc.textContent = `ë¯¸êµ­ ${countryKo}ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!`;
            } else {
                desc.textContent = `${countryKo} ì—¬í–‰ì„ ë– ë‚˜ë³¼ê¹Œìš”?`;
            }

            let videoId = country.videoId || "P_upO4tqLTk";
            const startParam = country.videoStart ? `&start=${country.videoStart}` : "";
            
            iframe.src = `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&rel=0&showinfo=0&modestbranding=1${startParam}`;
            
            if (fallbackLink) {
                fallbackLink.href = `https://www.youtube.com/results?search_query=travel+${encodeURIComponent(countryEn || countryKo)}`;
                fallbackLink.textContent = "ğŸ“º ë” ë§ì€ ì˜ìƒ ê²€ìƒ‰í•˜ê¸°";
            }
            modal.classList.remove('hidden');
        }

        function closeModal() {
            const modal = document.getElementById('video-modal');
            const iframe = document.getElementById('reward-video');
            iframe.src = ""; 
            modal.classList.add('hidden');
            if(isAnswered) nextRound();
        }

        window.onload = initMap;
    </script>
</body>
</html>
